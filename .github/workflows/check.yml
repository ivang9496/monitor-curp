name: Monitor OpenVPN Nativo

on:
  schedule:
    - cron: '*/20 * * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v3

      - name: Instalar OpenVPN
        run: |
          sudo apt-get update
          sudo apt-get install -y openvpn unzip

      - name: Configurar VPN (México)
        env:
          # IMPORTANTE: Aquí usamos las credenciales largas (Service Credentials)
          VPN_USER: ${{ secrets.PROXY_USER }}
          VPN_PASS: ${{ secrets.PROXY_PASS }}
        run: |
          # 1. Crear archivo de credenciales (auth.txt)
          echo "$VPN_USER" > auth.txt
          echo "$VPN_PASS" >> auth.txt
          chmod 600 auth.txt

          # 2. Descargar configuración de un servidor TCP en México (mx162)
          # Usamos TCP porque GitHub no lo bloquea
          wget https://downloads.nordcdn.com/configs/files/ovpn_tcp/servers/mx162.nordvpn.com.tcp.ovpn -O mexico.ovpn

          # 3. Iniciar la VPN en modo demonio (segundo plano)
          sudo openvpn --config mexico.ovpn --auth-user-pass auth.txt --daemon

          # 4. Esperar a que conecte (damos 30 segundos)
          echo "Conectando a México..."
          sleep 30

      - name: Verificar IP (Prueba de conexión)
        run: |
          # Esto nos dirá si realmente estamos en México
          curl -s https://ipinfo.io/country
          
      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Instalar librerías
        run: pip install requests

      - name: Ejecutar script
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_DESTINO: ${{ secrets.EMAIL_DESTINO }}
        run: python monitor_citas.py

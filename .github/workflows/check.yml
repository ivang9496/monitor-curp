name: Monitor VPN Nativa

on:
  schedule:
    - cron: '*/20 * * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v3

      - name: Instalar NordVPN
        run: |
          # 1. Descargar el instalador oficial
          wget -qnc https://repo.nordvpn.com/deb/nordvpn/debian/pool/main/nordvpn-release_1.0.0_all.deb
          # 2. Instalar el repositorio
          sudo dpkg -i nordvpn-release_1.0.0_all.deb
          # 3. Actualizar e instalar la app
          sudo apt-get update
          sudo apt-get install -y nordvpn

      - name: Conectar a México
        env:
          NORDVPN_TOKEN: ${{ secrets.NORDVPN_TOKEN }}
        run: |
          # 1. Iniciar sesión con el Token
          sudo nordvpn login --token "$NORDVPN_TOKEN"
          # 2. Configurar para máxima compatibilidad
          sudo nordvpn set technology openvpn
          sudo nordvpn set protocol tcp
          sudo nordvpn set obfuscate on
          # 3. Conectar a México
          sudo nordvpn connect Mexico
          # 4. Verificar IP (opcional, para ver en los logs que funcionó)
          curl -s https://api.nordvpn.com/vpn/check/full | grep country

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Instalar librerías
        run: pip install requests

      - name: Ejecutar script
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_DESTINO: ${{ secrets.EMAIL_DESTINO }}
        run: python monitor_citas.py

name: Monitor OpenVPN Auto-Detect

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v3

      - name: Instalar Herramientas
        run: |
          sudo apt-get update
          sudo apt-get install -y openvpn unzip jq curl

      - name: Configurar VPN (Auto-México)
        env:
          VPN_USER: ${{ secrets.PROXY_USER }}
          VPN_PASS: ${{ secrets.PROXY_PASS }}
        run: |
          # 1. Crear credenciales
          echo "$VPN_USER" > auth.txt
          echo "$VPN_PASS" >> auth.txt
          chmod 600 auth.txt

          # 2. PREGUNTAR a NordVPN cuál es el mejor servidor TCP en México (ID 140)
          echo "Buscando el mejor servidor en México..."
          SERVER_INFO=$(curl -s "https://api.nordvpn.com/v1/servers/recommendations?filters\[country_id\]=140&filters\[servers_technologies\]\[identifier\]=openvpn_tcp&limit=1")
          
          # Extraer el nombre del servidor (ej. mx165.nordvpn.com)
          HOSTNAME=$(echo $SERVER_INFO | jq -r '.[0].hostname')
          echo "Servidor seleccionado: $HOSTNAME"

          # 3. Descargar la configuración de ESE servidor específico
          URL="https://downloads.nordcdn.com/configs/files/ovpn_tcp/servers/${HOSTNAME}.tcp.ovpn"
          echo "Descargando configuración de: $URL"
          wget -q $URL -O mexico.ovpn

          # 4. Iniciar la VPN
          sudo openvpn --config mexico.ovpn --auth-user-pass auth.txt --daemon

          # 5. Esperar conexión
          echo "Esperando conexión..."
          sleep 30

      - name: Verificar IP (Prueba de Fuego)
        run: |
          # Verificamos si la IP cambió a México
          COUNTRY=$(curl -s https://ipinfo.io/country)
          IP=$(curl -s https://api.ipify.org)
          echo "Estás navegando desde: $COUNTRY (IP: $IP)"

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Instalar librerías
        run: pip install requests

      - name: Ejecutar script
        env:
          EMAIL_USER: ${{ secrets.EMAIL_USER }}
          EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
          EMAIL_DESTINO: ${{ secrets.EMAIL_DESTINO }}
        run: python monitor_citas.py
